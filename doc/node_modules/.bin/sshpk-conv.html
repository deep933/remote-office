<!DOCTYPE html>
<html>
<head>
  <title>sshpk-conv</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/.bin/sshpk-conv";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>sshpk-conv</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">#!/usr/bin/env node</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>-<em>- mode: js -</em>-
vim: set filetype=javascript :
Copyright 2018 Joyent, Inc.	All rights reserved.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> dashdash = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dashdash'</span>);
<span class="hljs-keyword">var</span> sshpk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/index'</span>);
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> tty = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tty'</span>);
<span class="hljs-keyword">var</span> readline = <span class="hljs-built_in">require</span>(<span class="hljs-string">'readline'</span>);
<span class="hljs-keyword">var</span> getPassword = <span class="hljs-built_in">require</span>(<span class="hljs-string">'getpass'</span>).getPass;

<span class="hljs-keyword">var</span> options = [
	{
		<span class="hljs-attr">names</span>: [<span class="hljs-string">'outformat'</span>, <span class="hljs-string">'t'</span>],
		<span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
		<span class="hljs-attr">help</span>: <span class="hljs-string">'Output format'</span>
	},
	{
		<span class="hljs-attr">names</span>: [<span class="hljs-string">'informat'</span>, <span class="hljs-string">'T'</span>],
		<span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
		<span class="hljs-attr">help</span>: <span class="hljs-string">'Input format'</span>
	},
	{
		<span class="hljs-attr">names</span>: [<span class="hljs-string">'file'</span>, <span class="hljs-string">'f'</span>],
		<span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
		<span class="hljs-attr">help</span>: <span class="hljs-string">'Input file name (default stdin)'</span>
	},
	{
		<span class="hljs-attr">names</span>: [<span class="hljs-string">'out'</span>, <span class="hljs-string">'o'</span>],
		<span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
		<span class="hljs-attr">help</span>: <span class="hljs-string">'Output file name (default stdout)'</span>
	},
	{
		<span class="hljs-attr">names</span>: [<span class="hljs-string">'private'</span>, <span class="hljs-string">'p'</span>],
		<span class="hljs-attr">type</span>: <span class="hljs-string">'bool'</span>,
		<span class="hljs-attr">help</span>: <span class="hljs-string">'Produce a private key as output'</span>
	},
	{
		<span class="hljs-attr">names</span>: [<span class="hljs-string">'derive'</span>, <span class="hljs-string">'d'</span>],
		<span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
		<span class="hljs-attr">help</span>: <span class="hljs-string">'Output a new key derived from this one, with given algo'</span>
	},
	{
		<span class="hljs-attr">names</span>: [<span class="hljs-string">'identify'</span>, <span class="hljs-string">'i'</span>],
		<span class="hljs-attr">type</span>: <span class="hljs-string">'bool'</span>,
		<span class="hljs-attr">help</span>: <span class="hljs-string">'Print key metadata instead of converting'</span>
	},
	{
		<span class="hljs-attr">names</span>: [<span class="hljs-string">'fingerprint'</span>, <span class="hljs-string">'F'</span>],
		<span class="hljs-attr">type</span>: <span class="hljs-string">'bool'</span>,
		<span class="hljs-attr">help</span>: <span class="hljs-string">'Output key fingerprint'</span>
	},
	{
		<span class="hljs-attr">names</span>: [<span class="hljs-string">'hash'</span>, <span class="hljs-string">'H'</span>],
		<span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
		<span class="hljs-attr">help</span>: <span class="hljs-string">'Hash function to use for key fingeprint with -F'</span>
	},
	{
		<span class="hljs-attr">names</span>: [<span class="hljs-string">'spki'</span>, <span class="hljs-string">'s'</span>],
		<span class="hljs-attr">type</span>: <span class="hljs-string">'bool'</span>,
		<span class="hljs-attr">help</span>: <span class="hljs-string">'With -F, generates an SPKI fingerprint instead of SSH'</span>
	},
	{
		<span class="hljs-attr">names</span>: [<span class="hljs-string">'comment'</span>, <span class="hljs-string">'c'</span>],
		<span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
		<span class="hljs-attr">help</span>: <span class="hljs-string">'Set key comment, if output format supports'</span>
	},
	{
		<span class="hljs-attr">names</span>: [<span class="hljs-string">'help'</span>, <span class="hljs-string">'h'</span>],
		<span class="hljs-attr">type</span>: <span class="hljs-string">'bool'</span>,
		<span class="hljs-attr">help</span>: <span class="hljs-string">'Shows this help text'</span>
	}
];

<span class="hljs-keyword">if</span> (<span class="hljs-built_in">require</span>.main === <span class="hljs-built_in">module</span>) {
	<span class="hljs-keyword">var</span> parser = dashdash.createParser({
		<span class="hljs-attr">options</span>: options
	});

	<span class="hljs-keyword">try</span> {
		<span class="hljs-keyword">var</span> opts = parser.parse(process.argv);
	} <span class="hljs-keyword">catch</span> (e) {
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'sshpk-conv: error: %s'</span>, e.message);
		process.exit(<span class="hljs-number">1</span>);
	}

	<span class="hljs-keyword">if</span> (opts.help || opts._args.length &gt; <span class="hljs-number">1</span>) {
		<span class="hljs-keyword">var</span> help = parser.help({}).trimRight();
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'sshpk-conv: converts between SSH key formats\n'</span>);
		<span class="hljs-built_in">console</span>.error(help);
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'\navailable key formats:'</span>);
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'	 - pem, pkcs1	  eg id_rsa'</span>);
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'	 - ssh		  eg id_rsa.pub'</span>);
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'	 - pkcs8	  format you want for openssl'</span>);
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'	 - openssh	  like output of ssh-keygen -o'</span>);
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'	 - rfc4253	  raw OpenSSH wire format'</span>);
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'	 - dnssec	  dnssec-keygen format'</span>);
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'  - putty          PuTTY ppk format'</span>);
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'\navailable fingerprint formats:'</span>);
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'  - hex            colon-separated hex for SSH'</span>);
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'                   straight hex for SPKI'</span>);
		<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'  - base64         SHA256:* format from OpenSSH'</span>);
		process.exit(<span class="hljs-number">1</span>);
	}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>Key derivation can only be done on private keys, so use of the -d
option necessarily implies -p.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">	<span class="hljs-keyword">if</span> (opts.derive)
		opts.private = <span class="hljs-literal">true</span>;

	<span class="hljs-keyword">var</span> inFile = process.stdin;
	<span class="hljs-keyword">var</span> inFileName = <span class="hljs-string">'stdin'</span>;

	<span class="hljs-keyword">var</span> inFilePath;
	<span class="hljs-keyword">if</span> (opts.file) {
		inFilePath = opts.file;
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (opts._args.length === <span class="hljs-number">1</span>) {
		inFilePath = opts._args[<span class="hljs-number">0</span>];
	}

	<span class="hljs-keyword">if</span> (inFilePath)
		inFileName = path.basename(inFilePath);

	<span class="hljs-keyword">try</span> {
		<span class="hljs-keyword">if</span> (inFilePath) {
			fs.accessSync(inFilePath, fs.R_OK);
			inFile = fs.createReadStream(inFilePath);
		}
	} <span class="hljs-keyword">catch</span> (e) {
		ifError(e, <span class="hljs-string">'error opening input file'</span>);
	}

	<span class="hljs-keyword">var</span> outFile = process.stdout;

	<span class="hljs-keyword">try</span> {
		<span class="hljs-keyword">if</span> (opts.out &amp;&amp; !opts.identify) {
			fs.accessSync(path.dirname(opts.out), fs.W_OK);
			outFile = fs.createWriteStream(opts.out);
		}
	} <span class="hljs-keyword">catch</span> (e) {
		ifError(e, <span class="hljs-string">'error opening output file'</span>);
	}

	<span class="hljs-keyword">var</span> bufs = [];
	inFile.on(<span class="hljs-string">'readable'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">var</span> data;
		<span class="hljs-keyword">while</span> ((data = inFile.read()))
			bufs.push(data);
	});
	<span class="hljs-keyword">var</span> parseOpts = {};
	parseOpts.filename = inFileName;
	inFile.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processKey</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">var</span> buf = Buffer.concat(bufs);
		<span class="hljs-keyword">var</span> fmt = <span class="hljs-string">'auto'</span>;
		<span class="hljs-keyword">if</span> (opts.informat)
			fmt = opts.informat;
		<span class="hljs-keyword">var</span> f = sshpk.parseKey;
		<span class="hljs-keyword">if</span> (opts.private)
			f = sshpk.parsePrivateKey;
		<span class="hljs-keyword">try</span> {
			<span class="hljs-keyword">var</span> key = f(buf, fmt, parseOpts);
		} <span class="hljs-keyword">catch</span> (e) {
			<span class="hljs-keyword">if</span> (e.name === <span class="hljs-string">'KeyEncryptedError'</span>) {
				getPassword(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, pw</span>) </span>{
					<span class="hljs-keyword">if</span> (err)
						ifError(err);
					parseOpts.passphrase = pw;
					processKey();
				});
				<span class="hljs-keyword">return</span>;
			}
			ifError(e);
		}

		<span class="hljs-keyword">if</span> (opts.derive)
			key = key.derive(opts.derive);

		<span class="hljs-keyword">if</span> (opts.comment)
			key.comment = opts.comment;

		<span class="hljs-keyword">if</span> (opts.identify) {
			<span class="hljs-keyword">var</span> kind = <span class="hljs-string">'public'</span>;
			<span class="hljs-keyword">if</span> (sshpk.PrivateKey.isPrivateKey(key))
				kind = <span class="hljs-string">'private'</span>;
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'%s: a %d bit %s %s key'</span>, inFileName,
			    key.size, key.type.toUpperCase(), kind);
			<span class="hljs-keyword">if</span> (key.type === <span class="hljs-string">'ecdsa'</span>)
				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ECDSA curve: %s'</span>, key.curve);
			<span class="hljs-keyword">if</span> (key.comment)
				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Comment: %s'</span>, key.comment);
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'SHA256 fingerprint: '</span> +
			    key.fingerprint(<span class="hljs-string">'sha256'</span>).toString());
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'MD5 fingerprint: '</span> +
			    key.fingerprint(<span class="hljs-string">'md5'</span>).toString());
			<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'SPKI-SHA256 fingerprint: '</span> +
			    key.fingerprint(<span class="hljs-string">'sha256'</span>, <span class="hljs-string">'spki'</span>).toString());
			process.exit(<span class="hljs-number">0</span>);
			<span class="hljs-keyword">return</span>;
		}

		<span class="hljs-keyword">if</span> (opts.fingerprint) {
			<span class="hljs-keyword">var</span> hash = opts.hash;
			<span class="hljs-keyword">var</span> type = opts.spki ? <span class="hljs-string">'spki'</span> : <span class="hljs-string">'ssh'</span>;
			<span class="hljs-keyword">var</span> format = opts.outformat;
			<span class="hljs-keyword">var</span> fp = key.fingerprint(hash, type).toString(format);
			outFile.write(fp);
			outFile.write(<span class="hljs-string">'\n'</span>);
			outFile.once(<span class="hljs-string">'drain'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
				process.exit(<span class="hljs-number">0</span>);
			});
			<span class="hljs-keyword">return</span>;
		}

		fmt = <span class="hljs-literal">undefined</span>;
		<span class="hljs-keyword">if</span> (opts.outformat)
			fmt = opts.outformat;
		outFile.write(key.toBuffer(fmt));
		<span class="hljs-keyword">if</span> (fmt === <span class="hljs-string">'ssh'</span> ||
		    (!opts.private &amp;&amp; fmt === <span class="hljs-literal">undefined</span>))
			outFile.write(<span class="hljs-string">'\n'</span>);
		outFile.once(<span class="hljs-string">'drain'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
			process.exit(<span class="hljs-number">0</span>);
		});
	});
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ifError</span>(<span class="hljs-params">e, txt</span>) </span>{
	<span class="hljs-keyword">if</span> (txt)
		txt = txt + <span class="hljs-string">': '</span>;
	<span class="hljs-keyword">else</span>
		txt = <span class="hljs-string">''</span>;
	<span class="hljs-built_in">console</span>.error(<span class="hljs-string">'sshpk-conv: '</span> + txt + e.name + <span class="hljs-string">': '</span> + e.message);
	<span class="hljs-keyword">if</span> (process.env[<span class="hljs-string">'DEBUG'</span>] || process.env[<span class="hljs-string">'V'</span>]) {
		<span class="hljs-built_in">console</span>.error(e.stack);
		<span class="hljs-keyword">if</span> (e.innerErr)
			<span class="hljs-built_in">console</span>.error(e.innerErr.stack);
	}
	process.exit(<span class="hljs-number">1</span>);
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
