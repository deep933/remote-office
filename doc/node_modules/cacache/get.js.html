<!DOCTYPE html>
<html>
<head>
  <title>get.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/cacache/get.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>get.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>

<span class="hljs-keyword">const</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)

<span class="hljs-keyword">const</span> figgyPudding = <span class="hljs-built_in">require</span>(<span class="hljs-string">'figgy-pudding'</span>)
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">const</span> index = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/entry-index'</span>)
<span class="hljs-keyword">const</span> memo = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/memoization'</span>)
<span class="hljs-keyword">const</span> read = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/content/read'</span>)

<span class="hljs-keyword">const</span> Minipass = <span class="hljs-built_in">require</span>(<span class="hljs-string">'minipass'</span>)
<span class="hljs-keyword">const</span> Collect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'minipass-collect'</span>)
<span class="hljs-keyword">const</span> Pipeline = <span class="hljs-built_in">require</span>(<span class="hljs-string">'minipass-pipeline'</span>)

<span class="hljs-keyword">const</span> writeFile = util.promisify(fs.writeFile)

<span class="hljs-keyword">const</span> GetOpts = figgyPudding({
  <span class="hljs-attr">integrity</span>: {},
  <span class="hljs-attr">memoize</span>: {},
  <span class="hljs-attr">size</span>: {}
})

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span> (<span class="hljs-params">cache, key, opts</span>) </span>{
  <span class="hljs-keyword">return</span> getData(<span class="hljs-literal">false</span>, cache, key, opts)
}
<span class="hljs-built_in">module</span>.exports.byDigest = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getByDigest</span> (<span class="hljs-params">cache, digest, opts</span>) </span>{
  <span class="hljs-keyword">return</span> getData(<span class="hljs-literal">true</span>, cache, digest, opts)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getData</span> (<span class="hljs-params">byDigest, cache, key, opts</span>) </span>{
  opts = GetOpts(opts)
  <span class="hljs-keyword">const</span> memoized = byDigest
    ? memo.get.byDigest(cache, key, opts)
    : memo.get(cache, key, opts)
  <span class="hljs-keyword">if</span> (memoized &amp;&amp; opts.memoize !== <span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(
      byDigest
        ? memoized
        : {
          <span class="hljs-attr">metadata</span>: memoized.entry.metadata,
          <span class="hljs-attr">data</span>: memoized.data,
          <span class="hljs-attr">integrity</span>: memoized.entry.integrity,
          <span class="hljs-attr">size</span>: memoized.entry.size
        }
    )
  }
  <span class="hljs-keyword">return</span> (byDigest ? <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-literal">null</span>) : index.find(cache, key, opts)).then(
    <span class="hljs-function">(<span class="hljs-params">entry</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!entry &amp;&amp; !byDigest) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> index.NotFoundError(cache, key)
      }
      <span class="hljs-keyword">return</span> read(cache, byDigest ? key : entry.integrity, {
        <span class="hljs-attr">integrity</span>: opts.integrity,
        <span class="hljs-attr">size</span>: opts.size
      })
        .then(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span>
          byDigest
            ? data
            : {
              <span class="hljs-attr">metadata</span>: entry.metadata,
              <span class="hljs-attr">data</span>: data,
              <span class="hljs-attr">size</span>: entry.size,
              <span class="hljs-attr">integrity</span>: entry.integrity
            }
        )
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (opts.memoize &amp;&amp; byDigest) {
            memo.put.byDigest(cache, key, res, opts)
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (opts.memoize) {
            memo.put(cache, entry, res.data, opts)
          }
          <span class="hljs-keyword">return</span> res
        })
    }
  )
}

<span class="hljs-built_in">module</span>.exports.sync = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span> (<span class="hljs-params">cache, key, opts</span>) </span>{
  <span class="hljs-keyword">return</span> getDataSync(<span class="hljs-literal">false</span>, cache, key, opts)
}
<span class="hljs-built_in">module</span>.exports.sync.byDigest = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getByDigest</span> (<span class="hljs-params">cache, digest, opts</span>) </span>{
  <span class="hljs-keyword">return</span> getDataSync(<span class="hljs-literal">true</span>, cache, digest, opts)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDataSync</span> (<span class="hljs-params">byDigest, cache, key, opts</span>) </span>{
  opts = GetOpts(opts)
  <span class="hljs-keyword">const</span> memoized = byDigest
    ? memo.get.byDigest(cache, key, opts)
    : memo.get(cache, key, opts)
  <span class="hljs-keyword">if</span> (memoized &amp;&amp; opts.memoize !== <span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">return</span> byDigest
      ? memoized
      : {
        <span class="hljs-attr">metadata</span>: memoized.entry.metadata,
        <span class="hljs-attr">data</span>: memoized.data,
        <span class="hljs-attr">integrity</span>: memoized.entry.integrity,
        <span class="hljs-attr">size</span>: memoized.entry.size
      }
  }
  <span class="hljs-keyword">const</span> entry = !byDigest &amp;&amp; index.find.sync(cache, key, opts)
  <span class="hljs-keyword">if</span> (!entry &amp;&amp; !byDigest) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> index.NotFoundError(cache, key)
  }
  <span class="hljs-keyword">const</span> data = read.sync(cache, byDigest ? key : entry.integrity, {
    <span class="hljs-attr">integrity</span>: opts.integrity,
    <span class="hljs-attr">size</span>: opts.size
  })
  <span class="hljs-keyword">const</span> res = byDigest
    ? data
    : {
      <span class="hljs-attr">metadata</span>: entry.metadata,
      <span class="hljs-attr">data</span>: data,
      <span class="hljs-attr">size</span>: entry.size,
      <span class="hljs-attr">integrity</span>: entry.integrity
    }
  <span class="hljs-keyword">if</span> (opts.memoize &amp;&amp; byDigest) {
    memo.put.byDigest(cache, key, res, opts)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (opts.memoize) {
    memo.put(cache, entry, res.data, opts)
  }
  <span class="hljs-keyword">return</span> res
}

<span class="hljs-built_in">module</span>.exports.stream = getStream

<span class="hljs-keyword">const</span> getMemoizedStream = <span class="hljs-function">(<span class="hljs-params">memoized</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">new</span> Minipass()
  stream.on(<span class="hljs-string">'newListener'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ev, cb</span>) </span>{
    ev === <span class="hljs-string">'metadata'</span> &amp;&amp; cb(memoized.entry.metadata)
    ev === <span class="hljs-string">'integrity'</span> &amp;&amp; cb(memoized.entry.integrity)
    ev === <span class="hljs-string">'size'</span> &amp;&amp; cb(memoized.entry.size)
  })
  stream.end(memoized.data)
  <span class="hljs-keyword">return</span> stream
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStream</span> (<span class="hljs-params">cache, key, opts</span>) </span>{
  opts = GetOpts(opts)
  <span class="hljs-keyword">const</span> memoized = memo.get(cache, key, opts)
  <span class="hljs-keyword">if</span> (memoized &amp;&amp; opts.memoize !== <span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">return</span> getMemoizedStream(memoized)
  }

  <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">new</span> Pipeline()
  index
    .find(cache, key)
    .then(<span class="hljs-function">(<span class="hljs-params">entry</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!entry) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> index.NotFoundError(cache, key)
      }
      stream.emit(<span class="hljs-string">'metadata'</span>, entry.metadata)
      stream.emit(<span class="hljs-string">'integrity'</span>, entry.integrity)
      stream.emit(<span class="hljs-string">'size'</span>, entry.size)
      stream.on(<span class="hljs-string">'newListener'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ev, cb</span>) </span>{
        ev === <span class="hljs-string">'metadata'</span> &amp;&amp; cb(entry.metadata)
        ev === <span class="hljs-string">'integrity'</span> &amp;&amp; cb(entry.integrity)
        ev === <span class="hljs-string">'size'</span> &amp;&amp; cb(entry.size)
      })

      <span class="hljs-keyword">const</span> src = read.readStream(
        cache,
        entry.integrity,
        opts.concat({
          <span class="hljs-attr">size</span>: opts.size == <span class="hljs-literal">null</span> ? entry.size : opts.size
        })
      )

      <span class="hljs-keyword">if</span> (opts.memoize) {
        <span class="hljs-keyword">const</span> memoStream = <span class="hljs-keyword">new</span> Collect.PassThrough()
        memoStream.on(<span class="hljs-string">'collect'</span>, data =&gt; memo.put(cache, entry, data, opts))
        stream.unshift(memoStream)
      }
      stream.unshift(src)
    })
    .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> stream.emit(<span class="hljs-string">'error'</span>, err))

  <span class="hljs-keyword">return</span> stream
}

<span class="hljs-built_in">module</span>.exports.stream.byDigest = getStreamDigest

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStreamDigest</span> (<span class="hljs-params">cache, integrity, opts</span>) </span>{
  opts = GetOpts(opts)
  <span class="hljs-keyword">const</span> memoized = memo.get.byDigest(cache, integrity, opts)
  <span class="hljs-keyword">if</span> (memoized &amp;&amp; opts.memoize !== <span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">new</span> Minipass()
    stream.end(memoized)
    <span class="hljs-keyword">return</span> stream
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> stream = read.readStream(cache, integrity, opts)
    <span class="hljs-keyword">if</span> (!opts.memoize) {
      <span class="hljs-keyword">return</span> stream
    }
    <span class="hljs-keyword">const</span> memoStream = <span class="hljs-keyword">new</span> Collect.PassThrough()
    memoStream.on(<span class="hljs-string">'collect'</span>, data =&gt; memo.put.byDigest(
      cache,
      integrity,
      data,
      opts
    ))
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Pipeline(stream, memoStream)
  }
}

<span class="hljs-built_in">module</span>.exports.info = info

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">info</span> (<span class="hljs-params">cache, key, opts</span>) </span>{
  opts = GetOpts(opts)
  <span class="hljs-keyword">const</span> memoized = memo.get(cache, key, opts)
  <span class="hljs-keyword">if</span> (memoized &amp;&amp; opts.memoize !== <span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(memoized.entry)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> index.find(cache, key)
  }
}

<span class="hljs-built_in">module</span>.exports.hasContent = read.hasContent

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cp</span> (<span class="hljs-params">cache, key, dest, opts</span>) </span>{
  <span class="hljs-keyword">return</span> copy(<span class="hljs-literal">false</span>, cache, key, dest, opts)
}

<span class="hljs-built_in">module</span>.exports.copy = cp

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cpDigest</span> (<span class="hljs-params">cache, digest, dest, opts</span>) </span>{
  <span class="hljs-keyword">return</span> copy(<span class="hljs-literal">true</span>, cache, digest, dest, opts)
}

<span class="hljs-built_in">module</span>.exports.copy.byDigest = cpDigest

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copy</span> (<span class="hljs-params">byDigest, cache, key, dest, opts</span>) </span>{
  opts = GetOpts(opts)
  <span class="hljs-keyword">if</span> (read.copy) {
    <span class="hljs-keyword">return</span> (byDigest
      ? <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-literal">null</span>)
      : index.find(cache, key, opts)
    ).then(<span class="hljs-function">(<span class="hljs-params">entry</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!entry &amp;&amp; !byDigest) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> index.NotFoundError(cache, key)
      }
      <span class="hljs-keyword">return</span> read
        .copy(cache, byDigest ? key : entry.integrity, dest, opts)
        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> byDigest
            ? key
            : {
              <span class="hljs-attr">metadata</span>: entry.metadata,
              <span class="hljs-attr">size</span>: entry.size,
              <span class="hljs-attr">integrity</span>: entry.integrity
            }
        })
    })
  }

  <span class="hljs-keyword">return</span> getData(byDigest, cache, key, opts).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> writeFile(dest, byDigest ? res : res.data).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> byDigest
        ? key
        : {
          <span class="hljs-attr">metadata</span>: res.metadata,
          <span class="hljs-attr">size</span>: res.size,
          <span class="hljs-attr">integrity</span>: res.integrity
        }
    })
  })
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
