<!DOCTYPE html>
<html>
<head>
  <title>auto.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/async/auto.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>auto.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>;

<span class="hljs-built_in">Object</span>.defineProperty(exports, <span class="hljs-string">"__esModule"</span>, {
    <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span>
});

exports.default = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tasks, concurrency, callback</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> concurrency === <span class="hljs-string">'function'</span>) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>concurrency is optional, shift the args.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        callback = concurrency;
        concurrency = <span class="hljs-literal">null</span>;
    }
    callback = (<span class="hljs-number">0</span>, _once2.default)(callback || _noop2.default);
    <span class="hljs-keyword">var</span> keys = (<span class="hljs-number">0</span>, _keys2.default)(tasks);
    <span class="hljs-keyword">var</span> numTasks = keys.length;
    <span class="hljs-keyword">if</span> (!numTasks) {
        <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>);
    }
    <span class="hljs-keyword">if</span> (!concurrency) {
        concurrency = numTasks;
    }

    <span class="hljs-keyword">var</span> results = {};
    <span class="hljs-keyword">var</span> runningTasks = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> hasError = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">var</span> listeners = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">var</span> readyTasks = [];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>for cycle detection:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> readyToCheck = []; <span class="hljs-comment">// tasks that have been identified as reachable</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>without the possibility of returning to an ancestor task</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> uncheckedDependencies = {};

    (<span class="hljs-number">0</span>, _baseForOwn2.default)(tasks, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">task, key</span>) </span>{
        <span class="hljs-keyword">if</span> (!(<span class="hljs-number">0</span>, _isArray2.default)(task)) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>no dependencies</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            enqueueTask(key, [task]);
            readyToCheck.push(key);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">var</span> dependencies = task.slice(<span class="hljs-number">0</span>, task.length - <span class="hljs-number">1</span>);
        <span class="hljs-keyword">var</span> remainingDependencies = dependencies.length;
        <span class="hljs-keyword">if</span> (remainingDependencies === <span class="hljs-number">0</span>) {
            enqueueTask(key, task);
            readyToCheck.push(key);
            <span class="hljs-keyword">return</span>;
        }
        uncheckedDependencies[key] = remainingDependencies;

        (<span class="hljs-number">0</span>, _arrayEach2.default)(dependencies, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">dependencyName</span>) </span>{
            <span class="hljs-keyword">if</span> (!tasks[dependencyName]) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'async.auto task `'</span> + key + <span class="hljs-string">'` has a non-existent dependency `'</span> + dependencyName + <span class="hljs-string">'` in '</span> + dependencies.join(<span class="hljs-string">', '</span>));
            }
            addListener(dependencyName, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                remainingDependencies--;
                <span class="hljs-keyword">if</span> (remainingDependencies === <span class="hljs-number">0</span>) {
                    enqueueTask(key, task);
                }
            });
        });
    });

    checkForDeadlocks();
    processQueue();

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">enqueueTask</span>(<span class="hljs-params">key, task</span>) </span>{
        readyTasks.push(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            runTask(key, task);
        });
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processQueue</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (readyTasks.length === <span class="hljs-number">0</span> &amp;&amp; runningTasks === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> callback(<span class="hljs-literal">null</span>, results);
        }
        <span class="hljs-keyword">while</span> (readyTasks.length &amp;&amp; runningTasks &lt; concurrency) {
            <span class="hljs-keyword">var</span> run = readyTasks.shift();
            run();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addListener</span>(<span class="hljs-params">taskName, fn</span>) </span>{
        <span class="hljs-keyword">var</span> taskListeners = listeners[taskName];
        <span class="hljs-keyword">if</span> (!taskListeners) {
            taskListeners = listeners[taskName] = [];
        }

        taskListeners.push(fn);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">taskComplete</span>(<span class="hljs-params">taskName</span>) </span>{
        <span class="hljs-keyword">var</span> taskListeners = listeners[taskName] || [];
        (<span class="hljs-number">0</span>, _arrayEach2.default)(taskListeners, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fn</span>) </span>{
            fn();
        });
        processQueue();
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">runTask</span>(<span class="hljs-params">key, task</span>) </span>{
        <span class="hljs-keyword">if</span> (hasError) <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">var</span> taskCallback = (<span class="hljs-number">0</span>, _onlyOnce2.default)(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, result</span>) </span>{
            runningTasks--;
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &gt; <span class="hljs-number">2</span>) {
                result = (<span class="hljs-number">0</span>, _slice2.default)(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
            }
            <span class="hljs-keyword">if</span> (err) {
                <span class="hljs-keyword">var</span> safeResults = {};
                (<span class="hljs-number">0</span>, _baseForOwn2.default)(results, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val, rkey</span>) </span>{
                    safeResults[rkey] = val;
                });
                safeResults[key] = result;
                hasError = <span class="hljs-literal">true</span>;
                listeners = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);

                callback(err, safeResults);
            } <span class="hljs-keyword">else</span> {
                results[key] = result;
                taskComplete(key);
            }
        });

        runningTasks++;
        <span class="hljs-keyword">var</span> taskFn = (<span class="hljs-number">0</span>, _wrapAsync2.default)(task[task.length - <span class="hljs-number">1</span>]);
        <span class="hljs-keyword">if</span> (task.length &gt; <span class="hljs-number">1</span>) {
            taskFn(results, taskCallback);
        } <span class="hljs-keyword">else</span> {
            taskFn(taskCallback);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkForDeadlocks</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Kahn's algorithm
https://en.wikipedia.org/wiki/Topological_sorting#Kahn.27s_algorithm
http://connalle.blogspot.com/2013/10/topological-sortingkahn-algorithm.html</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">var</span> currentTask;
        <span class="hljs-keyword">var</span> counter = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (readyToCheck.length) {
            currentTask = readyToCheck.pop();
            counter++;
            (<span class="hljs-number">0</span>, _arrayEach2.default)(getDependents(currentTask), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">dependent</span>) </span>{
                <span class="hljs-keyword">if</span> (--uncheckedDependencies[dependent] === <span class="hljs-number">0</span>) {
                    readyToCheck.push(dependent);
                }
            });
        }

        <span class="hljs-keyword">if</span> (counter !== numTasks) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'async.auto cannot execute tasks due to a recursive dependency'</span>);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDependents</span>(<span class="hljs-params">taskName</span>) </span>{
        <span class="hljs-keyword">var</span> result = [];
        (<span class="hljs-number">0</span>, _baseForOwn2.default)(tasks, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">task, key</span>) </span>{
            <span class="hljs-keyword">if</span> ((<span class="hljs-number">0</span>, _isArray2.default)(task) &amp;&amp; (<span class="hljs-number">0</span>, _baseIndexOf2.default)(task, taskName, <span class="hljs-number">0</span>) &gt;= <span class="hljs-number">0</span>) {
                result.push(key);
            }
        });
        <span class="hljs-keyword">return</span> result;
    }
};

<span class="hljs-keyword">var</span> _arrayEach = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash/_arrayEach'</span>);

<span class="hljs-keyword">var</span> _arrayEach2 = _interopRequireDefault(_arrayEach);

<span class="hljs-keyword">var</span> _baseForOwn = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash/_baseForOwn'</span>);

<span class="hljs-keyword">var</span> _baseForOwn2 = _interopRequireDefault(_baseForOwn);

<span class="hljs-keyword">var</span> _baseIndexOf = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash/_baseIndexOf'</span>);

<span class="hljs-keyword">var</span> _baseIndexOf2 = _interopRequireDefault(_baseIndexOf);

<span class="hljs-keyword">var</span> _isArray = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash/isArray'</span>);

<span class="hljs-keyword">var</span> _isArray2 = _interopRequireDefault(_isArray);

<span class="hljs-keyword">var</span> _keys = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash/keys'</span>);

<span class="hljs-keyword">var</span> _keys2 = _interopRequireDefault(_keys);

<span class="hljs-keyword">var</span> _noop = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash/noop'</span>);

<span class="hljs-keyword">var</span> _noop2 = _interopRequireDefault(_noop);

<span class="hljs-keyword">var</span> _slice = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./internal/slice'</span>);

<span class="hljs-keyword">var</span> _slice2 = _interopRequireDefault(_slice);

<span class="hljs-keyword">var</span> _once = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./internal/once'</span>);

<span class="hljs-keyword">var</span> _once2 = _interopRequireDefault(_once);

<span class="hljs-keyword">var</span> _onlyOnce = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./internal/onlyOnce'</span>);

<span class="hljs-keyword">var</span> _onlyOnce2 = _interopRequireDefault(_onlyOnce);

<span class="hljs-keyword">var</span> _wrapAsync = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./internal/wrapAsync'</span>);

<span class="hljs-keyword">var</span> _wrapAsync2 = _interopRequireDefault(_wrapAsync);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_interopRequireDefault</span>(<span class="hljs-params">obj</span>) </span>{ <span class="hljs-keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : { <span class="hljs-attr">default</span>: obj }; }

<span class="hljs-built_in">module</span>.exports = exports[<span class="hljs-string">'default'</span>];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<div class="dox">
<div class="summary">
<p>Determines the best order for running the {@link AsyncFunction}s in <code>tasks</code>, based on
their requirements. Each function can optionally depend on other functions
being completed first, and each function is run as soon as its requirements
are satisfied.</p>
</div>
<div class="body">
<p>If any of the {@link AsyncFunction}s pass an error to their callback, the <code>auto</code> sequence
will stop. Further tasks will not execute (so any other functions depending
on it will not run), and the main <code>callback</code> is immediately called with the
error.</p>
<p>{@link AsyncFunction}s also receive an object containing the results of functions which
have completed so far as the first argument, if they have dependencies. If a
task function has no dependencies, it will only be passed a callback.</p>
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">tasks</span>
<span class="dox_type">Object</span>
<span><ul>
<li>An object. Each of its properties is either a function or an array of requirements, with the {@link AsyncFunction} itself the last item
in the array. The object's key of a property serves as the name of the task
defined by that property, i.e. can be used when specifying requirements for
other tasks. The function receives one or two arguments:</li>
</ul>
<ul>
<li>a <code>results</code> object, containing the results of the previously executed
functions, only passed if the task has any dependencies,</li>
<li>a <code>callback(err, result)</code> function, which must be called when finished,
passing an <code>error</code> (which can be <code>null</code>) and the result of the function's
execution.</li>
</ul>
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[concurrency=Infinity]</span>
<span class="dox_type">number</span>
<span><ul>
<li>An optional <code>integer</code> for determining the maximum number of tasks that can be run in parallel. By
default, as many as possible.</li>
</ul>
</span>
</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[callback]</span>
<span class="dox_type">Function</span>
<span><ul>
<li>An optional callback which is called when all the tasks have been completed. It receives the <code>err</code> argument if any <code>tasks</code>
pass an error to their callback. Results are always returned; however, if an
error occurs, no further <code>tasks</code> will be performed, and the results object
will only contain partial results. Invoked with (err, results).</li>
</ul>
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"></pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
